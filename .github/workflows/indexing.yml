name: Google Indexing API (Final Fix)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # [ìˆ˜ì • 1] JSON í‚¤ íŒŒì¼ì„ ì•ˆì „í•˜ê²Œ ìƒì„± (ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ ê¹¨ì§ ë°©ì§€)
      - name: Create Service Account Key File
        run: |
          echo '${{ secrets.INDEXING_SERVICE_ACCOUNT }}' > service_account.json

      - name: Generate URL List and Request Indexing
        run: |
          # 1. ì‚¬ì´íŠ¸ë§µì—ì„œ URL ì¶”ì¶œ (GitHub Pages íŠ¹ì„±ìƒ ëì— / ìœ ë¬´ê°€ ì¤‘ìš”í•¨)
          DOMAIN="https://hyungjinhan.github.io"

          # ì‚¬ì´íŠ¸ë§µì„ ê°€ì ¸ì™€ì„œ URLë§Œ ì •ë°€í•˜ê²Œ ì¶”ì¶œ
          curl -s "$DOMAIN/sitemap.xml" | \
          grep -oP 'https://hyungjinhan\.github\.io/[^\s<]*' | \
          sed 's/<\/loc>//g' | \
          sort -u | head -n 200 > urls.txt

          echo "ì´ $(wc -l < urls.txt) ê°œì˜ URLì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."

          # [ìˆ˜ì • 2] npx ë„êµ¬ê°€ ë‚´ë¶€ì ìœ¼ë¡œ credentialì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ëª…ì‹œì  ì‹¤í–‰
          # ì¼ë¶€ npx ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ í™˜ê²½ë³€ìˆ˜ëª…ì„ ë‹¤ë¥´ê²Œ ìš”êµ¬í•  ìˆ˜ ìˆìŒ
          while IFS= read -r url; do
            clean_url=$(echo "$url" | xargs)
            if [ -n "$clean_url" ]; then
              echo "ğŸš€ ìš”ì²­ ì¤‘: $clean_url"
              # npx ë„êµ¬ì— ë”°ë¼ GOOGLE_APPLICATION_CREDENTIALSë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ë„ë¡ ê°•ì œ
              GOOGLE_APPLICATION_CREDENTIALS=./service_account.json npx google-indexing-script "$clean_url" || echo "âš ï¸ ì‹¤íŒ¨: $clean_url"
            fi
          done < urls.txt
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ./service_account.json
