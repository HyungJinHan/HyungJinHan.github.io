name: Google Indexing API (Final Fix)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create Service Account Key File
        run: |
          # JSONÏùÑ Í∞ÄÏû• ÏïàÏ†ÑÌïòÍ≤å ÎßåÎìúÎäî Î∞©ÏãùÏûÖÎãàÎã§.
          cat > service_account.json << 'EOF'
          ${{ secrets.INDEXING_SERVICE_ACCOUNT }}
          EOF
          # ÌååÏùºÏù¥ ÎπÑÏñ¥ÏûàÎäîÏßÄ ÌòπÏùÄ JSON ÌòïÏãùÏù¥ ÎßûÎäîÏßÄ Í∞ÑÎã®Ìûà Ï≤¥ÌÅ¨
          if [ ! -s service_account.json ]; then echo "‚ùå SecretÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§."; exit 1; fi

      - name: Generate URL List and Request Indexing
        run: |
          DOMAIN="https://hyungjinhan.github.io"

          # sitemapÏóêÏÑú URL Ï∂îÏ∂ú (ÌÉúÍ∑∏ Ï†úÍ±∞ Î≥¥Í∞ï)
          curl -s "$DOMAIN/sitemap.xml" | \
          grep -oP 'https://hyungjinhan\.github\.io/[^\s<]*' | \
          sed 's/<\/loc>//g' | \
          sort -u | head -n 200 > urls.txt

          echo "‚úÖ Ï¥ù $(wc -l < urls.txt) Í∞úÏùò URLÏùÑ Î∞úÍ≤¨ÌñàÏäµÎãàÎã§."

          # ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏ Î∞è Ïã§Ìñâ
          export GOOGLE_APPLICATION_CREDENTIALS=$GITHUB_WORKSPACE/service_account.json

          while IFS= read -r url; do
            clean_url=$(echo "$url" | xargs)
            if [ -n "$clean_url" ]; then
              echo "üöÄ ÏöîÏ≤≠ Ï§ë: $clean_url"
              # npx ÎèÑÍµ¨ Ïã§Ìñâ (ÏóêÎü¨ Î∞úÏÉù Ïãú Î°úÍ∑∏ ÌôïÏù∏Ïö©)
              npx google-indexing-script "$clean_url" || echo "‚ö†Ô∏è Ïã§Ìå® Î°úÍ∑∏ ÌôïÏù∏ ÌïÑÏöî: $clean_url"
            fi
          done < urls.txt
