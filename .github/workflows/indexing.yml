name: Google Indexing API (Final Fix)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create Service Account Key File
        run: |
          echo "${{ secrets.INDEXING_SERVICE_ACCOUNT }}" > service_account.json

      - name: Generate URL List and Request Indexing
        run: |
          # 1. ì‚¬ì´íŠ¸ë§µì—ì„œ URL ì¶”ì¶œ
          # [ìˆ˜ì •] í•œê¸€ ë””ì½”ë”©(python3) ë¶€ë¶„ì„ ì£¼ì„ ì²˜ë¦¬í•˜ê³  ì¸ì½”ë”©ëœ ì›ë³¸ ì£¼ì†Œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          DOMAIN="https://hyungjinhan.github.io"

          curl -s $DOMAIN/sitemap.xml | \
          grep -oP 'https://hyungjinhan\.github\.io/[^\s<]*' | \
          sort -u | head -n 200 > urls.txt

          # íŒŒì´ì¬ ë””ì½”ë”©ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ìœ„ grep ê²°ê³¼ê°€ ê·¸ëŒ€ë¡œ urls.txtì— ì €ì¥ë©ë‹ˆë‹¤.

          echo "ì´ $(wc -l < urls.txt) ê°œì˜ URLì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."

          # 2. ë°˜ë³µë¬¸ ì‹¤í–‰
          while IFS= read -r url; do
            # ê³µë°± ì œê±° ë° URL ëì˜ ìŠ¬ë˜ì‹œ(/) ë³´ì¡´ (ì†ì„± ì„¤ì •ê³¼ ì¼ì¹˜ì‹œí‚¤ê¸° ìœ„í•¨)
            clean_url=$(echo "$url" | xargs)

            if [ -n "$clean_url" ]; then
              echo "ğŸš€ ìš”ì²­ ì¤‘: $clean_url"
              # npx ì‹¤í–‰ ì‹œ ì—ëŸ¬ê°€ ë‚˜ë„ ë‹¤ìŒ URLë¡œ ê³„ì† ì§„í–‰
              npx google-indexing-script "$clean_url" || echo "âš ï¸ ì‹¤íŒ¨: $clean_url"
            fi
          done < urls.txt
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ./service_account.json
