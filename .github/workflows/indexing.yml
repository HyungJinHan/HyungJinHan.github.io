name: Google Indexing API (Auto-optimized)

on:
  push:
    branches:
      - main
  workflow_dispatch: # ì–¸ì œë“  ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create Service Account Key File
        run: |
          cat <<EOF > service_account.json
          ${{ secrets.INDEXING_SERVICE_ACCOUNT }}
          EOF

      - name: Generate URL List and Request Indexing
        run: |
          # 1. ì‚¬ì´íŠ¸ë§µì—ì„œ URL ì¶”ì¶œ (http/https í¬í•¨ ì „ì²´ ì£¼ì†Œ)
          # 2. 'tac'ìœ¼ë¡œ ìˆœì„œë¥¼ ë’¤ì§‘ì–´ ìµœì‹  ê¸€ì´ ìœ„ë¡œ ì˜¤ê²Œ í•¨ (ì‚¬ì´íŠ¸ë§µ êµ¬ì¡°ì— ë”°ë¼ ì„ íƒì )
          # 3. 'head -n 200'ìœ¼ë¡œ ì¼ì¼ í• ë‹¹ëŸ‰ë§Œí¼ë§Œ ìë¦„
          curl -s https://hyungjinhan.github.io/sitemap.xml | grep -oP 'https://[^\s<]+' | head -n 200 > urls.txt
          echo "ì´ $(wc -l < urls.txt) ê°œì˜ URLì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."

          # 2. ë°˜ë³µë¬¸ì„ ì‚¬ìš©í•˜ì—¬ URLì„ í•˜ë‚˜ì”© ì²˜ë¦¬
          # npx ëª…ë ¹ì–´ë¥¼ URLë§ˆë‹¤ ê°ê° ì‹¤í–‰í•˜ì—¬ ë„ë©”ì¸ ì˜¤ì¸ì‹ì„ ë°©ì§€í•©ë‹ˆë‹¤.
          while IFS= read -r url; do
            echo "ğŸš€ ìš”ì²­ ì¤‘: $url"
            npx google-indexing-script "$url"
          done < urls.txt
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ./service_account.json
