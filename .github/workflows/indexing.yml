name: Google Indexing API (Auto-optimized)

on:
  push:
    branches:
      - main
  workflow_dispatch: # 언제든 수동으로 실행 가능

jobs:
  indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create Service Account Key File
        run: |
          cat <<EOF > service_account.json
          ${{ secrets.INDEXING_SERVICE_ACCOUNT }}
          EOF

      - name: Generate URL List and Request Indexing
        run: |
          # 1. 사이트맵에서 URL 추출 (http/https 포함 전체 주소)
          # 2. 'tac'으로 순서를 뒤집어 최신 글이 위로 오게 함 (사이트맵 구조에 따라 선택적)
          # 3. 'head -n 200'으로 일일 할당량만큼만 자름
          curl -s https://hyungjinhan.github.io/sitemap.xml | grep -oP 'https://[^\s<]+' | head -n 200 > urls.txt

          URL_COUNT=$(wc -l < urls.txt)
          echo "총 $URL_COUNT 개의 URL을 구글에 전송합니다. (일일 한도 200개 내)"

          if [ $URL_COUNT -eq 0 ]; then
            echo "전송할 URL이 없습니다."
            exit 0
          fi

          # 인자 오류를 방지하기 위해 명확하게 실행
          npx google-indexing-script ./urls.txt
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ./service_account.json
