name: Google Indexing API (Fixed)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: |
          npm init -y
          npm install googleapis
          # ë˜ëŠ” ê¸€ë¡œë²Œ ì„¤ì¹˜
          # npm install -g googleapis

      - name: Create Service Account Key File
        run: |
          echo '${{ secrets.INDEXING_SERVICE_ACCOUNT }}' > service_account.json
          chmod 600 service_account.json

      - name: Generate URL List
        run: |
          DOMAIN="https://hyungjinhan.github.io"
          if curl --output /dev/null --silent --head --fail "$DOMAIN/sitemap.xml"; then
            curl -s "$DOMAIN/sitemap.xml" | grep -oP 'https://hyungjinhan\.github\.io[^< \n\r\t]*' | sort -u | head -n 200 > urls.txt
            echo "âœ… ì´ $(wc -l < urls.txt) ê°œì˜ URLì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."
            if [ ! -s urls.txt ]; then
              echo "âŒ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi
          else
            echo "âŒ sitemap.xmlì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

      - name: Index URLs
        run: |
          # package.json ìƒì„± (í•„ìš”í•œ ê²½ìš°)
          cat > package.json << 'EOF'
          {
            "name": "indexing-script",
            "version": "1.0.0",
            "dependencies": {
              "googleapis": "^126.0.1"
            }
          }
          EOF

          # ì˜ì¡´ì„± ì¬í™•ì¸
          npm install

          # ì¸ë±ì‹± ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > index.js << 'EOF'
          const { google } = require('googleapis');
          const fs = require('fs');
          const readline = require('readline');

          async function indexURL(url) {
            try {
              const auth = new google.auth.GoogleAuth({
                keyFile: './service_account.json',
                scopes: ['https://www.googleapis.com/auth/indexing'],
              });
              
              const client = await auth.getClient();
              const indexing = google.indexing({
                version: 'v3',
                auth: client,
              });
              
              const response = await indexing.urlNotifications.publish({
                requestBody: {
                  url: url.trim(),
                  type: 'URL_UPDATED',
                },
              });
              
              console.log(`âœ… ì„±ê³µ: ${url}`);
              return true;
            } catch (error) {
              console.error(`âŒ ì‹¤íŒ¨: ${url}`);
              console.error(`ì—ëŸ¬ ë©”ì‹œì§€: ${error.message}`);
              if (error.response) {
                console.error(`ì—ëŸ¬ ìƒì„¸:`, error.response.data);
              }
              return false;
            }
          }

          async function main() {
            if (!fs.existsSync('./urls.txt')) {
              console.error('urls.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
              process.exit(1);
            }

            const fileStream = fs.createReadStream('./urls.txt');
            const rl = readline.createInterface({
              input: fileStream,
              crlfDelay: Infinity,
            });

            let successCount = 0;
            let failCount = 0;

            for await (const line of rl) {
              const url = line.trim();
              if (url) {
                console.log(`\nğŸ“¤ ì²˜ë¦¬ ì¤‘: ${url}`);
                const success = await indexURL(url);
                if (success) {
                  successCount++;
                } else {
                  failCount++;
                }
                // API í• ë‹¹ëŸ‰ ê³ ë ¤í•˜ì—¬ ì§€ì—°
                await new Promise(resolve => setTimeout(resolve, 1000));
              }
            }

            console.log(`\nğŸ“Š ìµœì¢… ê²°ê³¼: ì„±ê³µ ${successCount}, ì‹¤íŒ¨ ${failCount}`);
          }

          main().catch(console.error);
          EOF

          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          node index.js
