name: Google Indexing API (Final Emergency)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Google Auth Library
        run: npm install googleauth

      - name: Create Service Account Key File
        run: |
          echo '${{ secrets.INDEXING_SERVICE_ACCOUNT }}' > service_account.json

      - name: Generate URL List and Request Indexing
        run: |
          # 1. ì‚¬ì´íŠ¸ë§µì—ì„œ ì˜ë¬¸/í•œê¸€ ëª¨ë“  URL ì¶”ì¶œ
          DOMAIN="https://hyungjinhan.github.io"
          curl -s "$DOMAIN/sitemap.xml" | grep -oP 'https://hyungjinhan\.github\.io/[^< \n\r\t]*' | sort -u | head -n 200 > urls.txt

          echo "ì´ $(wc -l < urls.txt) ê°œì˜ URLì„ ì „ì†¡í•©ë‹ˆë‹¤."

          # 2. curlê³¼ ì„œë¹„ìŠ¤ ê³„ì •ì„ ì´ìš©í•´ êµ¬ê¸€ APIì— ì§ì ‘ ìš”ì²­
          # ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ê·¸ë¥¼ ì›ì²œ ì°¨ë‹¨í•˜ê¸° ìœ„í•´ npx ëŒ€ì‹  ì§ì ‘ í˜¸ì¶œ ë°©ì‹ì„ ì‹œë„í•©ë‹ˆë‹¤.
          while IFS= read -r url; do
            clean_url=$(echo "$url" | xargs)
            if [ -n "$clean_url" ]; then
              echo "ğŸš€ ìš”ì²­ ì¤‘: $clean_url"
              # ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ì§ì ‘ ì‹¤í–‰í•˜ëŠ” ê°€ì¥ ì•ˆì „í•œ ë„êµ¬ ì‚¬ìš©
              npx @vinit-parekh/google-indexing-api "$clean_url" ./service_account.json || echo "âš ï¸ ì‹¤íŒ¨"
            fi
          done < urls.txt
