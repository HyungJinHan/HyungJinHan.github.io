name: Google Indexing API (Final Fix)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # [ìˆ˜ì • 1] JSON í‚¤ íŒŒì¼ì„ ê°€ì¥ ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ ìƒì„±
      # 'EOF'ë¥¼ ë”°ì˜´í‘œë¡œ ê°ì‹¸ë©´ GitHub Secret ë‚´ë¶€ì˜ íŠ¹ìˆ˜ë¬¸ì($ ë“±)ê°€ ë³€ì¡°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      - name: Create Service Account Key File
        run: |
          cat << 'EOF' > service_account.json
          ${{ secrets.INDEXING_SERVICE_ACCOUNT }}
          EOF

      - name: Generate URL List and Request Indexing
        run: |
          DOMAIN="https://hyungjinhan.github.io"

          # 1. ì‚¬ì´íŠ¸ë§µì—ì„œ URL ì¶”ì¶œ ë° ì •ì œ
          # grep ì´í›„ sedë¥¼ ì¶”ê°€í•˜ì—¬ XML íƒœê·¸ë¥¼ ì™„ì „íˆ ì œê±°í•©ë‹ˆë‹¤.
          curl -s "$DOMAIN/sitemap.xml" | \
          grep -oP 'https://hyungjinhan\.github\.io/[^\s<]*' | \
          sed 's/<\/loc>//g' | \
          sort -u | head -n 200 > urls.txt

          echo "âœ… ì´ $(wc -l < urls.txt) ê°œì˜ URLì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."

          # [ìˆ˜ì • 2] í™˜ê²½ ë³€ìˆ˜ë¥¼ 'ì ˆëŒ€ ê²½ë¡œ'ë¡œ ë‚´ë³´ë‚´ì–´ npx ì‹¤í–‰ ì‹œ í™•ì‹¤íˆ ì°¸ì¡°í•˜ê²Œ í•¨
          export GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/service_account.json

          # 2. ë°˜ë³µë¬¸ ì‹¤í–‰
          while IFS= read -r url; do
            clean_url=$(echo "$url" | xargs)

            if [ -n "$clean_url" ]; then
              echo "ğŸš€ ìš”ì²­ ì¤‘: $clean_url"
              # [ìˆ˜ì • 3] --yes í”Œë˜ê·¸ë¥¼ ì¶”ê°€í•˜ì—¬ ì„¤ì¹˜ í™•ì¸ í”„ë¡¬í”„íŠ¸ë¥¼ ë°©ì§€í•˜ê³  ì‹¤í–‰
              npx --yes google-indexing-script "$clean_url" || echo "âš ï¸ ì‹¤íŒ¨: $clean_url"
            fi
          done < urls.txt
        # env ì„¤ì •ì„ í•œ ë²ˆ ë” ëª…ì‹œí•˜ì—¬ ì´ì¤‘ ì ê¸ˆ
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/service_account.json
