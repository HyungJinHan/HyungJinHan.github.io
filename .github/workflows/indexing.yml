name: Google Indexing API (Auto-optimized)

on:
  push:
    branches:
      - main
  workflow_dispatch: # ì–¸ì œë“  ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create Service Account Key File
        run: |
          cat <<EOF > service_account.json
          ${{ secrets.INDEXING_SERVICE_ACCOUNT }}
          EOF

      - name: Generate URL List and Request Indexing
        run: |
          # 1. ì‚¬ì´íŠ¸ë§µì—ì„œ URL ì¶”ì¶œ í›„ ë””ì½”ë”© (í•œê¸€ ì£¼ì†Œ ë³µì›)
          # python3ë¥¼ ì´ìš©í•´ %EC... í˜•íƒœì˜ ì£¼ì†Œë¥¼ í•œê¸€ ì£¼ì†Œë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
          curl -s https://hyungjinhan.github.io/sitemap.xml | grep -oP 'https?://[^\s<]+' | python3 -c "import sys, urllib.parse; [print(urllib.parse.unquote(line.strip())) for line in sys.stdin]" | head -n 200 > urls.txt

          echo "ì´ $(wc -l < urls.txt) ê°œì˜ URLì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."

          # 2. ë°˜ë³µë¬¸ ì‹¤í–‰
          while IFS= read -r url; do
            clean_url=$(echo "$url" | tr -d '\r\n[:space:]')
            echo "ğŸš€ ìš”ì²­ ì¤‘: $clean_url"
            npx google-indexing-script "$clean_url"
          done < urls.txt
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ./service_account.json
